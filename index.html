<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mehnova - Google Map</title>
    <!-- Tailwind CSS -->
    <link href="https://unpkg.com/tailwindcss@3.4.10/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        #map {
            height: calc(100vh - 56px);
            width: 100%;
            margin-top: 56px;
            z-index: 2;
        }

        .custom-popup {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }

        .search-results {
            max-height: 200px;
            overflow-y: auto;
        }

        .custom-marker-label {
            /* background: #e5e7eb; */
            /* bg-gray-200 */
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            /* margin-left: 100px; */
            margin-top: -35px;
        }
    </style>
</head>

<body class="m-0 p-0">

    <!-- Navbar -->
    <nav class="fixed top-0 left-0 w-full bg-gray-800 text-white shadow-lg z-50">
        <div class="max-w-7xl mx-auto px-4 py-3 flex justify-start md:justify-center items-center">
            <h1 class="text-base hidden lg:block sm:text-lg mr-4 font-bold whitespace-nowrap">
                Pole Locations Map
            </h1>

            <div class="relative flex items-center gap-4 w-[70vw] lg:w-[50vw]">
                <div class="flex-1 relative">
                    <input id="searchBox" type="text" placeholder="Search pole/site/name..."
                        class="w-full px-3 py-2 rounded text-black outline-none" />
                    <div id="searchResults"
                        class="absolute top-10 left-0 w-full bg-white text-black rounded shadow-lg hidden search-results">
                    </div>
                </div>

                <button onclick="resetMap()" class="px-4 py-2 rounded-lg hidden lg:block text-white text-base lg:text-lg
               bg-indigo-600/90 hover:bg-indigo-600 active:bg-indigo-700
               shadow-md shadow-indigo-600/20 transition duration-300">
                    Reset Map
                </button>
            </div>

            <span class="absolute right-3 font-semibold font-arial lg:text-3xl text-base whitespace-nowrap">
                @Manish
            </span>
        </div>
    </nav>

    <!-- Map -->
    <div id="map" class="mt-14"></div>

    <script>
        let map, polesData = [], markers = [];
        const searchBox = document.getElementById("searchBox");
        const searchResults = document.getElementById("searchResults");
        let debounceTimeout;
        let infoWindow;

        function initialize() {
            const center = { lat: 28.631562208651633, lng: 77.21960333877945 };

            map = new google.maps.Map(document.getElementById("map"), {
                center: center,
                zoom: 17,
            });

            // ðŸ”¹ Ek hi InfoWindow object banao
            infoWindow = new google.maps.InfoWindow();
            // ðŸ”¹ Map pe click karte hi popup close ho jaye
            map.addListener("click", () => {
                infoWindow.close();
            });
            fetch('poles.json')
                .then(response => response.json())
                .then(data => {
                    polesData = data;

                    data.forEach(pole => {
                        const position = { lat: pole.latitude, lng: pole.longitude };

                        const marker = new google.maps.Marker({
                            position,
                            map,
                            // title: `#${pole.pole_no} | ${pole.site}`,
                            label: {
                                text: `#${pole.pole_no} | ${pole.site}`,
                                className: "custom-marker-label bg-gray-200",
                            },
                            icon: "https://maps.gstatic.com/mapfiles/api-3/images/spotlight-poi3.png"
                        });

                        // ðŸ”¹ Marker click par wahi global infoWindow use karo
                        marker.addListener("click", () => {
                            infoWindow.setContent(`
            <div class="custom-popup">
              <strong>Channel No:</strong> ${pole.pole_no}<br>
              <strong>Site:</strong> ${pole.site}<br>
              <strong>Name:</strong> ${pole.name}<br><br>
              <button id="copyBtn-${pole.id}"
                class="mt-2 px-3 py-1 bg-indigo-600 text-white rounded text-sm">
                ðŸ“‹ Copy
              </button>
            </div>
          `);

                            infoWindow.open(map, marker);

                            google.maps.event.addListenerOnce(infoWindow, "domready", () => {
                                const btn = document.getElementById(`copyBtn-${pole.id}`);
                                if (btn) {
                                    btn.addEventListener("click", () => {
                                        copyToClipboard(pole);
                                        btn.classList.remove("bg-indigo-600", "hover:bg-indigo-700");
                                        btn.classList.add("bg-green-600", "hover:bg-green-700");
                                        btn.textContent = "âœ… Copied!";
                                        setTimeout(() => {
                                            btn.classList.remove("bg-green-600", "hover:bg-green-700");
                                            btn.classList.add("bg-indigo-600", "hover:bg-indigo-700");
                                            btn.textContent = "ðŸ“‹ Copy";
                                        }, 3000);
                                    });
                                }
                            });
                        });

                        markers.push({ ...pole, marker });
                    });
                });
        }

        // DateTime format
        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString("en-GB", {
                day: "2-digit",
                month: "2-digit",
                year: "numeric",
                hour: "numeric",
                minute: "2-digit",
                second: "2-digit",
                hour12: true
            });
        }

        function copyToClipboard(pole) {
            const currentTime = getCurrentDateTime();
            const text = `Ticket ID :- NDMC_
Indus Id :- ${pole.indus_id}
Location :- ${pole.name}
Alarm generated time :- ${currentTime}
Alarm cleared time :-
RCA:- `;

            navigator.clipboard.writeText(text).then(() => {
                showToast("Copied to clipboard âœ…");
            }).catch(err => {
                console.error("Failed to copy: ", err);
            });
        }

        function showToast(msg) {
            const toast = document.createElement("div");
            toast.textContent = msg;
            toast.className = "fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded shadow-lg z-50";
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 5000);
        }

        // Search with debounce
        searchBox.addEventListener("input", () => {
            clearTimeout(debounceTimeout);
            debounceTimeout = setTimeout(() => {
                const query = searchBox.value.toLowerCase();
                if (!query) {
                    searchResults.classList.add("hidden");
                    return;
                }
                const results = polesData.filter(pole =>
                    pole.pole_no.toString().includes(query) ||
                    pole.site.toLowerCase().includes(query) ||
                    pole.name.toLowerCase().includes(query)
                );
                displayResults(results);
            }, 300);
        });

        function displayResults(results) {
            if (results.length === 0) {
                searchResults.innerHTML = `<div class="px-3 py-2 text-gray-500">No results found</div>`;
            } else {
                searchResults.innerHTML = results.map(r => `
          <div class="px-3 py-2 hover:bg-gray-200 cursor-pointer" onclick="focusOnPole(${r.id})">
            <strong>#${r.pole_no}</strong> - ${r.site} (${r.name})
          </div>
        `).join("");
            }
            searchResults.classList.remove("hidden");
        }

        // Focus on pole
        window.focusOnPole = (id) => {
            const pole = markers.find(m => m.id === id);
            if (pole) {
                map.setCenter({ lat: pole.latitude, lng: pole.longitude });
                map.setZoom(18);

                // InfoWindow ka content update karke open karte hain
                infoWindow.setContent(`
      <div class="custom-popup">
        <strong>Channel No:</strong> ${pole.pole_no}<br>
        <strong>Site:</strong> ${pole.site}<br>
        <strong>Name:</strong> ${pole.name}<br><br>
        <button id="copyBtn-${pole.id}"
          class="mt-2 px-3 py-1 bg-indigo-600 text-white rounded text-sm">
          ðŸ“‹ Copy
        </button>
      </div>
    `);

                infoWindow.open(map, pole.marker);

                // search results clear
                searchResults.classList.add("hidden");
                searchBox.value = "";

                // Button event bind (kyunki popup DOM me baad me aata hai)
                google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                    document.getElementById(`copyBtn-${pole.id}`).addEventListener("click", () => {
                        navigator.clipboard.writeText(`${pole.pole_no}, ${pole.site}, ${pole.name}`);
                        alert("Copied!");
                    });
                });
            }
        };

        function resetMap() {
            map.setCenter({ lat: 28.631562208651633, lng: 77.21960333877945 });
            map.setZoom(17);
        }
    </script>

    <!-- Google Maps API -->
    <script
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBvnHKYalPScRMFLmx-vUsfdLwkRxAyjyw&callback=initialize"
        async defer></script>
</body>

</html>
